// é€™å€‹æª”æ¡ˆå°±åƒæ˜¯ä½¿ç”¨è€…æœå‹™ä¸­å¿ƒï¼
// å®ƒè² è²¬è™•ç†æ‰€æœ‰è·Ÿä½¿ç”¨è€…æœ‰é—œçš„äº‹æƒ…ï¼šè¨»å†Šã€ç™»å…¥ã€ç™»å‡ºã€æŸ¥æ‰¾ç­‰ç­‰

// å¼•å…¥å„ç¨®å·¥å…·åŒ…ï¼Œå°±åƒä½œæ–™ç†å‰è¦æº–å‚™å„ç¨®å·¥å…·
import express from "express"; // Expressæ¡†æ¶ï¼Œå»ºç«‹ç¶²ç«™çš„ä¸»è¦å·¥å…·
import multer from "multer"; // è™•ç†ä¸Šå‚³æª”æ¡ˆçš„å·¥å…·
import bcrypt from "bcrypt"; // å¯†ç¢¼åŠ å¯†å·¥å…·ï¼Œä¿è­·å¯†ç¢¼å®‰å…¨
import jwt from "jsonwebtoken"; // ç™¼æ”¾ç™»å…¥è¨¼æ˜çš„å·¥å…·ï¼Œåƒé€šè¡Œè­‰
import mysql from "mysql2/promise"; // é€£æ¥MySQLè³‡æ–™åº«çš„å·¥å…·
import connection from "../connect.js"; // å¼•å…¥æˆ‘å€‘è¨­å®šå¥½çš„è³‡æ–™åº«é€£ç·š

// è¨­å®šä¸Šå‚³æª”æ¡ˆè™•ç†å™¨
const upload = multer();

// å¾ç’°å¢ƒè®Šæ•¸å–å¾—ç¥•å¯†é‡‘é‘°ï¼Œç”¨ä¾†è£½ä½œç™»å…¥è¨¼æ˜çš„ç¥•å¯†é…æ–¹
const secretKey = process.env.JWT_SECRET_KEY;

// å»ºç«‹ä½¿ç”¨è€…è·¯ç”±å™¨ï¼šå°±åƒè¨­ç«‹ä¸€å€‹å°ˆé–€è™•ç†ä½¿ç”¨è€…äº‹å‹™çš„æ«ƒæª¯
const router = express.Router();

// ===== ä½¿ç”¨è€…ç›¸é—œçš„å„ç¨®æœå‹™åŠŸèƒ½ =====
// route(s) è·¯ç”±è¦å‰‡(å€‘)
// routes routers (è·¯ç”±ç‰©ä»¶å™¨)

// ğŸ“‹ åŠŸèƒ½1ï¼šç²å–æ‰€æœ‰ä½¿ç”¨è€…æ¸…å–®
// å°±åƒå•è€å¸«ï¼šã€Œç­ä¸Šæœ‰å“ªäº›åŒå­¸ï¼Ÿã€
router.get("/", async (req, res) => {
  try {
    // å˜—å˜—çœ‹èƒ½ä¸èƒ½æˆåŠŸ
    // å¾è³‡æ–™åº«ä¸­å–å¾—æ‰€æœ‰ä½¿ç”¨è€…çš„è³‡æ–™
    const sql = "SELECT * FROM `users`;";
    let [users] = await connection.execute(sql); // åŸ·è¡ŒSQLæŒ‡ä»¤ä¸¦ç­‰å¾…çµæœ

    // æˆåŠŸçš„è©±ï¼ŒæŠŠçµæœå‚³å›çµ¦å®¢äºº
    res.status(200).json({
      // 200ä»£è¡¨ã€ŒæˆåŠŸã€
      status: "success", // å‘Šè¨´å®¢äººï¼šã€ŒæˆåŠŸäº†ï¼ã€
      data: users, // æŠŠæ‰€æœ‰ä½¿ç”¨è€…è³‡æ–™çµ¦å®¢äººçœ‹
      message: "å·²ç²å–æ‰€æœ‰ä½¿ç”¨è€…", // çµ¦å®¢äººçœ‹çš„èªªæ˜
    });
  } catch (error) {
    // å¦‚æœå‡ºéŒ¯çš„è©±
    // æ•ç²éŒ¯èª¤ï¼šå°±åƒæ•è›³è›‰ä¸€æ¨£ï¼ŒæŠŠéŒ¯èª¤æŠ“ä½è™•ç†
    console.log(error); // åœ¨æ§åˆ¶å°å°å‡ºéŒ¯èª¤è¨Šæ¯ï¼Œæ–¹ä¾¿ç¨‹å¼å“¡é™¤éŒ¯

    // è¨­å®šé è¨­å€¼ï¼Œå¦‚æœæ²’æœ‰ç‰¹å®šéŒ¯èª¤ç¢¼å°±ç”¨é è¨­çš„
    const statusCode = error.code ?? 401; // ??æ„æ€æ˜¯ã€Œå¦‚æœç‚ºç©ºå°±ç”¨401ã€
    const statusText = error.status ?? "error";
    const message = error.message ?? "èº«åˆ†é©—è­‰éŒ¯èª¤ï¼Œè«‹æ´½ç®¡ç†äººå“¡";

    // å‘Šè¨´å®¢äººå‡ºéŒ¯äº†
    res.status(statusCode).json({
      status: statusText,
      message, // message: message çš„ç°¡å¯«
    });
  }
});

// ğŸ” åŠŸèƒ½2ï¼šæœå°‹ä½¿ç”¨è€…
// å°±åƒåœ¨ç­ç´šåå†Šä¸­æ‰¾ç‰¹å®šçš„åŒå­¸
router.get("/search", (req, res) => {
  // ç¶²å€åƒæ•¸(æŸ¥è©¢åƒæ•¸)æœƒè¢«æ•´ç†åˆ° req ä¸­çš„ query è£¡
  // ä¾‹å¦‚ï¼š/api/users/search?key=å°æ˜
  const key = req.query.key; // å–å¾—ä½¿ç”¨è€…æƒ³æœå°‹çš„é—œéµå­—

  res.status(200).json({
    status: "success", // å‘Šè¨´å®¢äººï¼šã€Œæœå°‹æˆåŠŸï¼ã€
    data: { key }, // æŠŠæœå°‹çš„é—œéµå­—å›å‚³çµ¦å®¢äººçœ‹
    message: "æœå°‹ä½¿ç”¨è€… æˆåŠŸ", // çµ¦å®¢äººçœ‹çš„èªªæ˜
  });
});

// ğŸ‘¤ åŠŸèƒ½3ï¼šç²å–ç‰¹å®šä½¿ç”¨è€…çš„è©³ç´°è³‡è¨Š
// å°±åƒåœ¨é€šè¨ŠéŒ„ä¸­æŸ¥æ‰¾ç‰¹å®šäººçš„è³‡æ–™
router.get("/:id", async (req, res) => {
  try {
    // å˜—å˜—çœ‹èƒ½ä¸èƒ½æˆåŠŸ
    // è·¯ç”±åƒæ•¸ï¼šå¾ç¶²å€ä¸­å–å¾—ä½¿ç”¨è€…çš„å¸³è™Ÿ
    // ä¾‹å¦‚ï¼š/api/users/john ä¸­çš„ john å°±æ˜¯ id
    const account = req.params.id;

    // æª¢æŸ¥æ˜¯å¦æœ‰æä¾›å¸³è™Ÿ
    if (!account) {
      const err = new Error("è«‹æä¾›ä½¿ç”¨è€… ID"); // å»ºç«‹ä¸€å€‹éŒ¯èª¤è¨Šæ¯
      err.code = 400; // è¨­å®šéŒ¯èª¤ä»£ç¢¼ï¼š400ä»£è¡¨ã€Œå®¢æˆ¶è¨Šæ¯æœ‰å•é¡Œã€
      err.status = "fail"; // è¨­å®šç‹€æ…‹
      throw err; // ä¸Ÿå‡ºéŒ¯èª¤ï¼Œè·³åˆ°catchå€å¡Š
    }

    // å¾è³‡æ–™åº«ä¸­æœå°‹é€™å€‹å¸³è™Ÿçš„ä½¿ç”¨è€…
    const sqlCheck1 = "SELECT * FROM `users` WHERE `account` = ?;";
    let user = await connection
      .execute(sqlCheck1, [account]) // åŸ·è¡ŒSQLæŒ‡ä»¤ï¼Œ?æœƒè¢«æ›´æ›æˆaccountçš„å€¼
      .then(([result]) => {
        // ç­‰åŸ·è¡Œå®Œæˆå¾Œ
        return result[0]; // å–ç¬¬ä¸€ç­†çµæœï¼ˆå¸³è™Ÿæ˜¯å”¯ä¸€çš„ï¼‰
      });

    // æª¢æŸ¥æ˜¯å¦æ‰¾åˆ°é€™å€‹ä½¿ç”¨è€…
    if (!user) {
      const err = new Error("æ‰¾ä¸åˆ°ä½¿ç”¨è€…"); // å»ºç«‹éŒ¯èª¤è¨Šæ¯
      err.code = 404; // 404ä»£è¡¨ã€Œæ‰¾ä¸åˆ°è³‡æ–™ã€
      err.status = "fail";
      throw err;
    }

    // å¾ä½¿ç”¨è€…è³‡æ–™ä¸­ç§»é™¤æ•æ„Ÿè³‡è¨Šï¼ˆidå’Œå¯†ç¢¼ï¼‰
    // å°±åƒæ˜¯æŠŠèº«åˆ†è­‰ä¸Šçš„æ•æ„Ÿè³‡è¨Šé®èµ·ä¾†
    const { id, password, ...data } = user;

    // æˆåŠŸå›å‚³ä½¿ç”¨è€…è³‡æ–™ï¼ˆä½†ä¸åŒ…å«idå’Œå¯†ç¢¼ï¼‰
    res.status(200).json({
      status: "success", // å‘Šè¨´å®¢äººï¼šã€Œæ‰¾åˆ°äº†ï¼ã€
      data: data, // ä½¿ç”¨è€…çš„å®‰å…¨è³‡æ–™ï¼ˆä¸åŒ…å«å¯†ç¢¼ï¼‰
      message: "æŸ¥è©¢æˆåŠŸ", // çµ¦å®¢äººçœ‹çš„èªªæ˜
    });
  } catch (error) {
    // å¦‚æœå‡ºéŒ¯çš„è©±
    // æ•ç²éŒ¯èª¤è™•ç†ï¼šè·Ÿä¸Šé¢ä¸€æ¨£çš„éŒ¯èª¤è™•ç†æ©Ÿåˆ¶
    console.log(error);
    const statusCode = error.code ?? 401;
    const statusText = error.status ?? "error";
    const message = error.message ?? "èº«åˆ†é©—è­‰éŒ¯èª¤ï¼Œè«‹æ´½ç®¡ç†äººå“¡";
    res.status(statusCode).json({
      status: statusText,
      message, // message: message
    });
  }
});

// â• åŠŸèƒ½4ï¼šæ–°å¢ä¸€å€‹ä½¿ç”¨è€…ï¼ˆè¨»å†ŠåŠŸèƒ½ï¼‰
// å°±åƒåœ¨å­¸æ ¡è¾¦ç†å…¥å­¸æ‰‹çºŒ
router.post("/", upload.none(), async (req, res) => {
  try {
    // å˜—å˜—çœ‹èƒ½ä¸èƒ½æˆåŠŸè¨»å†Š
    // å¾è¡¨å–®ä¸­å–å¾—ä½¿ç”¨è€…å¡«å¯«çš„è³‡æ–™
    // å°±åƒå¾å ±åè¡¨ä¸Šçœ‹å­¸ç”Ÿå¡«å¯«çš„å§“åã€å¯†ç¢¼ã€é›»å­ä¿¡ç®±
    const { account, password, mail } = req.body;
    // console.log({ account, password, mail });  // é€™è¡Œè¢«è¨»è§£æ‰äº†ï¼ŒåŸæœ¬æ˜¯ç”¨ä¾†é™¤éŒ¯çš„

    // æª¢æŸ¥å¿…å¡«æ¬„ä½ï¼šå°±åƒè€å¸«æª¢æŸ¥å­¸ç”Ÿæ˜¯å¦æŠŠè¡¨å–®å¡«å®Œæ•´
    if (!account || !password || !mail) {
      // å¦‚æœæœ‰ä»»ä½•ä¸€å€‹æ¬„ä½æ²’å¡«ï¼Œå°±å»ºç«‹ä¸€å€‹éŒ¯èª¤è¨Šæ¯
      const err = new Error("è«‹æä¾›å®Œæ•´çš„ä½¿ç”¨è€…è³‡è¨Š"); // å°±åƒè€å¸«èªªï¼šã€Œè¡¨å–®æ²’å¡«å®Œæ•´ï¼ã€
      err.code = 400; // è¨­å®šéŒ¯èª¤ä»£ç¢¼ï¼š400ä»£è¡¨ã€Œå®¢æˆ¶è³‡è¨Šæœ‰å•é¡Œã€
      err.status = "fail"; // è¨­å®šç‹€æ…‹ï¼šã€Œå¤±æ•—ã€
      throw err; // ä¸Ÿå‡ºéŒ¯èª¤ï¼Œè·³åˆ°catchå€å¡Šè™•ç†

      // ä¸‹é¢é€™æ®µè¢«è¨»è§£æ‰çš„ä»£ç¢¼æ˜¯èˆŠçš„éŒ¯èª¤è™•ç†æ–¹å¼
      // return res.status(400).json({
      //   status: "fail",
      //   message: "è«‹æä¾›å®Œæ•´çš„ä½¿ç”¨è€…è³‡è¨Š",
      // });
    }

    // æª¢æŸ¥å¸³è™Ÿæœ‰æ²’æœ‰è¢«ä½¿ç”¨éï¼šå°±åƒæª¢æŸ¥å­¸è™Ÿæ˜¯å¦å·²ç¶“å­˜åœ¨
    const sqlCheck1 = "SELECT * FROM `users` WHERE `account` = ?;";
    let user = await connection
      .execute(sqlCheck1, [account]) // åŸ·è¡ŒSQLæŸ¥è©¢ï¼Œ?æœƒè¢«æ›´æ›æˆaccountçš„å€¼
      .then(([result]) => {
        // ç­‰æŸ¥è©¢çµæœå›ä¾†
        return result[0]; // å–ç¬¬ä¸€ç­†çµæœï¼ˆå¦‚æœæœ‰çš„è©±ï¼‰
      });

    // å¦‚æœæ‰¾åˆ°äº†ï¼Œè¡¨ç¤ºé€™å€‹å¸³è™Ÿå·²ç¶“è¢«ä½¿ç”¨äº†
    if (user) {
      const err = new Error("æä¾›çš„è¨»å†Šå…§å®¹å·²è¢«ä½¿ç”¨1"); // å°±åƒèªªï¼šã€Œé€™å€‹å¸³è™Ÿå·²ç¶“æœ‰äººç”¨äº†ï¼ã€
      err.code = 400;
      err.status = "fail";
      throw err; // ä¸Ÿå‡ºéŒ¯èª¤ï¼Œä¸è®“è¨»å†Šç¹¼çºŒ
    }

    // æª¢æŸ¥é›»å­ä¿¡ç®±æœ‰æ²’æœ‰è¢«ä½¿ç”¨éï¼šå°±åƒæª¢æŸ¥ä¿¡ç®±æ˜¯å¦å·²ç¶“è¨»å†Šé
    const sqlCheck2 = "SELECT * FROM `users` WHERE `mail` = ?;";
    user = await connection.execute(sqlCheck2, [mail]).then(([result]) => {
      return result[0]; // å–ç¬¬ä¸€ç­†çµæœï¼ˆå¦‚æœæœ‰çš„è©±ï¼‰
    });

    // å¦‚æœæ‰¾åˆ°äº†ï¼Œè¡¨ç¤ºé€™å€‹é›»å­ä¿¡ç®±å·²ç¶“è¢«ä½¿ç”¨äº†
    if (user) {
      const err = new Error("æä¾›çš„è¨»å†Šå…§å®¹å·²è¢«ä½¿ç”¨2"); // å°±åƒèªªï¼šã€Œé€™å€‹ä¿¡ç®±å·²ç¶“æœ‰äººç”¨äº†ï¼ã€
      err.code = 400;
      err.status = "fail";
      throw err; // ä¸Ÿå‡ºéŒ¯èª¤ï¼Œä¸è®“è¨»å†Šç¹¼çºŒ
    }

    // å¾ randomuser.me ç¶²ç«™å–å¾—ä¸€å€‹éš¨æ©Ÿçš„ä½¿ç”¨è€…é ­åƒåœ–ç‰‡
    // å°±åƒæ˜¯å¹«æ–°åŒå­¸æ‹ä¸€å¼µå­¸ç”Ÿè­‰ç…§ç‰‡
    const head = await getRandomAvatar();

    // æŠŠå¯†ç¢¼åŠ å¯†ï¼šå°±åƒæ˜¯æŠŠå¯†ç¢¼æ”¾é€²ä¿éšªç®±ï¼Œé˜²æ­¢è¢«å·çœ‹
    // bcrypt.hash æœƒæŠŠç°¡å–®çš„å¯†ç¢¼è®Šæˆè¤‡é›œçš„å¯†ç¢¼ï¼Œ10æ˜¯åŠ å¯†å¼·åº¦
    const hashedPassword = await bcrypt.hash(password, 10);

    // å»ºç«‹ SQL æŒ‡ä»¤ï¼šå°±åƒå¯«ä¸€å¼µã€Œè«‹å¹«æˆ‘æ–°å¢ä¸€ç­†è³‡æ–™ã€çš„ä¾¿æ¢
    const sql =
      "INSERT INTO `users` (account, password, mail, head) VALUES (?, ?, ?, ?);";
    // åŸ·è¡Œ SQL æŒ‡ä»¤ï¼ŒæŠŠæ–°ä½¿ç”¨è€…çš„è³‡æ–™å­˜å…¥è³‡æ–™åº«
    await connection.execute(sql, [account, hashedPassword, mail, head]);

    // è¨»å†ŠæˆåŠŸï¼å‘Šè¨´å®¢äººå¥½æ¶ˆæ¯
    res.status(201).json({
      // 201ä»£è¡¨ã€Œå·²å»ºç«‹æ–°è³‡æ–™ã€
      status: "success", // å‘Šè¨´å®¢äººï¼šã€Œè¨»å†ŠæˆåŠŸï¼ã€
      data: {}, // ç©ºè³‡æ–™ï¼ˆä¸å›å‚³æ•æ„Ÿè³‡è¨Šï¼‰
      message: "æ–°å¢ä¸€å€‹ä½¿ç”¨è€… æˆåŠŸ", // çµ¦å®¢äººçœ‹çš„æ­¡è¿è¨Šæ¯
    });
  } catch (error) {
    // å¦‚æœè¨»å†Šéç¨‹ä¸­å‡ºéŒ¯çš„è©±
    // æ•ç²éŒ¯èª¤è™•ç†ï¼šå°±åƒæ˜¯è™•ç†å ±åå‡ºéŒ¯çš„æƒ…æ³
    console.log(error); // åœ¨æ§åˆ¶å°å°å‡ºéŒ¯èª¤è¨Šæ¯ï¼Œå¹«åŠ©ç¨‹å¼å“¡é™¤éŒ¯

    // è¨­å®šé è¨­å€¼ï¼Œé˜²æ­¢ç³»çµ±å´©æ½°
    const statusCode = error.code ?? 500; // å¦‚æœæ²’æœ‰é”™èª¤ç¢¼å°±ç”¨500ï¼ˆä¼ºæœå™¨å…§éƒ¨éŒ¯èª¤ï¼‰
    const statusText = error.status ?? "error";
    const message = error.message ?? "è¨»å†Šå¤±æ•—ï¼Œè«‹æ´½ç®¡ç†äººå“¡";

    // å‘Šè¨´å®¢äººè¨»å†Šå¤±æ•—äº†
    res.status(statusCode).json({
      status: statusText,
      message, // message: message çš„ç°¡å¯«
    });
  }
});

// âœï¸ åŠŸèƒ½5ï¼šæ›´æ–°ç‰¹å®šä½¿ç”¨è€…çš„è³‡è¨Š
// å°±åƒæ˜¯ä¿®æ”¹å­¸ç”Ÿè³‡æ–™ï¼Œæ¯”å¦‚æ›´æ›é›»è©±æˆ–åœ°å€
router.put("/:id", (req, res) => {
  // å¾ç¶²å€ä¸­å–å¾—è¦æ›´æ–°çš„ä½¿ç”¨è€…ID
  const id = req.params.id;

  // ç›®å‰åªæ˜¯å›å‚³æˆåŠŸè¨Šæ¯ï¼Œé‚„æ²’æœ‰å¯¦éš›æ›´æ–°åŠŸèƒ½
  res.status(200).json({
    status: "success", // å‘Šè¨´å®¢äººï¼šã€Œæ›´æ–°æˆåŠŸï¼ã€
    data: { id }, // å›å‚³è¢«æ›´æ–°çš„ä½¿ç”¨è€…ID
    message: `å·²æˆåŠŸæ›´æ–° ${id} ä½¿ç”¨è€…`, // å‘Šè¨´å®¢äººæ›´æ–°äº†å“ªå€‹ä½¿ç”¨è€…
  });
});

// ğŸ—‘ï¸ åŠŸèƒ½6ï¼šåˆªé™¤ç‰¹å®šä½¿ç”¨è€…
// å°±åƒæ˜¯å¾ç­ç´šåå†Šä¸­åˆªé™¤è½‰å­¸çš„å­¸ç”Ÿ
router.delete("/:id", (req, res) => {
  // å¾ç¶²å€ä¸­å–å¾—è¦åˆªé™¤çš„ä½¿ç”¨è€…ID
  const id = req.params.id;

  // ç›®å‰åªæ˜¯å›å‚³æˆåŠŸè¨Šæ¯ï¼Œé‚„æ²’æœ‰å¯¦éš›åˆªé™¤åŠŸèƒ½
  res.status(200).json({
    status: "success", // å‘Šè¨´å®¢äººï¼šã€Œåˆªé™¤æˆåŠŸï¼ã€
    data: { id }, // å›å‚³è¢«åˆªé™¤çš„ä½¿ç”¨è€…ID
    message: `å·²æˆåŠŸåˆªé™¤ ${id} ä½¿ç”¨è€…`, // å‘Šè¨´å®¢äººåˆªé™¤äº†å“ªå€‹ä½¿ç”¨è€…
  });
});

// ğŸ” åŠŸèƒ½7ï¼šä½¿ç”¨è€…ç™»å…¥
// å°±åƒæ˜¯åœ¨å­¸æ ¡é–€å£æª¢æŸ¥å­¸ç”Ÿè­‰ï¼Œç¢ºèªèº«åˆ†å¾Œæ‰èƒ½é€²å…¥
router.post("/login", upload.none(), async (req, res) => {
  try {
    // å˜—å˜—çœ‹èƒ½ä¸èƒ½æˆåŠŸç™»å…¥
    // å¾è¡¨å–®ä¸­å–å¾—ä½¿ç”¨è€…å¡«å¯«çš„å¸³è™Ÿå’Œå¯†ç¢¼
    const { account, password } = req.body;
    console.log(account); // åœ¨æ§åˆ¶å°é¡¯ç¤ºæ˜¯å“ªå€‹å¸³è™Ÿåœ¨å˜—è©¦ç™»å…¥

    // å¾è³‡æ–™åº«ä¸­æŸ¥æ‰¾é€™å€‹å¸³è™Ÿçš„ä½¿ç”¨è€…è³‡æ–™
    const sqlCheck1 = "SELECT * FROM `users` WHERE `account` = ?";
    let user = await connection
      .execute(sqlCheck1, [account]) // åŸ·è¡ŒSQLæŸ¥è©¢
      .then(([result]) => {
        return result[0]; // å–ç¬¬ä¸€ç­†çµæœ
      });

    // console.log(user);  // é€™è¡Œè¢«è¨»è§£æ‰äº†ï¼ŒåŸæœ¬æ˜¯ç”¨ä¾†é™¤éŒ¯çš„

    // æª¢æŸ¥ï¼šå¦‚æœè³‡æ–™åº«ä¸­æ²’æœ‰é€™å€‹å¸³è™Ÿ
    if (!user) {
      const err = new Error("å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤1"); // ç‚ºäº†å®‰å…¨ï¼Œä¸èªªæ˜ç©¶ç«Ÿæ˜¯å¸³è™Ÿé‚„æ˜¯å¯†ç¢¼éŒ¯èª¤
      err.code = 400;
      err.status = "error";
      throw err; // ä¸Ÿå‡ºéŒ¯èª¤ï¼Œåœæ­¢ç™»å…¥ç¨‹åº

      // ä¸‹é¢é€™æ®µè¢«è¨»è§£æ‰çš„ä»£ç¢¼æ˜¯èˆŠçš„éŒ¯èª¤è™•ç†æ–¹å¼
      // return res.status(400).json({
      //   status: "error",
      //   message: "å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤",
      // });
    }

    // æª¢æŸ¥å¯†ç¢¼æ˜¯å¦æ­£ç¢ºï¼šç”¨bcryptæ¯”å°ä½¿ç”¨è€…è¼¸å…¥çš„å¯†ç¢¼å’Œè³‡æ–™åº«ä¸­çš„åŠ å¯†å¯†ç¢¼
    // å°±åƒæ˜¯æª¢æŸ¥é‘°åŒ™æ˜¯å¦èƒ½æ‰“é–‹é–
    const isMatch = await bcrypt.compare(password, user.password);
    if (!isMatch) {
      const err = new Error("å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤2"); // å¯†ç¢¼ä¸å°ï¼Œä½†ç‚ºäº†å®‰å…¨ä¸æ˜èªª
      err.code = 400;
      err.status = "error";
      throw err; // ä¸Ÿå‡ºéŒ¯èª¤ï¼Œç™»å…¥å¤±æ•—
    }

    console.log(user);

    // å¯†ç¢¼æ­£ç¢ºï¼è£½ä½œä¸€å€‹ç™»å…¥è¨¼æ˜ï¼ˆJWT Tokenï¼‰
    // å°±åƒæ˜¯ç™¼çµ¦å­¸ç”Ÿä¸€å¼µã€Œä»Šæ—¥å·²ç™»å…¥ã€çš„é€šè¡Œè­‰
    const token = jwt.sign(
      {
        // åœ¨è¨¼æ˜ä¸Šè¨˜éŒ„ä½¿ç”¨è€…çš„åŸºæœ¬è³‡æ–™
        account: user.account, // ä½¿ç”¨è€…å¸³è™Ÿ
        mail: user.mail, // ä½¿ç”¨è€…ä¿¡ç®±
        head: user.head, // ä½¿ç”¨è€…é ­åƒ
      },
      secretKey, // ç”¨ç¥•å¯†é‡‘é‘°åŠ å¯†è¨¼æ˜ï¼Œé˜²æ­¢è¢«å‡é€ 
      { expiresIn: "30m" } // è¨¼æ˜30åˆ†é˜å¾Œå°±æœƒéæœŸï¼Œéœ€è¦é‡æ–°ç™»å…¥
    );

    const newUser = {
      // åœ¨è¨¼æ˜ä¸Šè¨˜éŒ„ä½¿ç”¨è€…çš„åŸºæœ¬è³‡æ–™
      account: user.account, // ä½¿ç”¨è€…å¸³è™Ÿ
      mail: user.mail, // ä½¿ç”¨è€…ä¿¡ç®±
      head: user.head, // ä½¿ç”¨è€…é ­åƒ
    };

    // ç™»å…¥æˆåŠŸï¼æŠŠè¨¼æ˜çµ¦ä½¿ç”¨è€…
    res.status(200).json({
      status: "success", // å‘Šè¨´ä½¿ç”¨è€…ï¼šã€Œç™»å…¥æˆåŠŸï¼ã€
      message: "ç™»å…¥æˆåŠŸ", // æ­¡è¿è¨Šæ¯
      data: { token, user: newUser }, // æŠŠç™»å…¥è¨¼æ˜çµ¦ä½¿ç”¨è€…ä¿å­˜
    });
  } catch (error) {
    // å¦‚æœç™»å…¥éç¨‹ä¸­å‡ºéŒ¯çš„è©±
    // æ•ç²éŒ¯èª¤è™•ç†ï¼šè·Ÿè¨»å†ŠåŠŸèƒ½ä¸€æ¨£çš„éŒ¯èª¤è™•ç†æ©Ÿåˆ¶
    console.log(error); // åœ¨æ§åˆ¶å°å°å‡ºéŒ¯èª¤è¨Šæ¯

    const statusCode = error.code ?? 400;
    const statusText = error.status ?? "error";
    const message = error.message ?? "ç™»å…¥å¤±æ•—ï¼Œè«‹æ´½ç®¡ç†äººå“¡";

    // å‘Šè¨´ä½¿ç”¨è€…ç™»å…¥å¤±æ•—äº†
    res.status(statusCode).json({
      status: statusText,
      message, // message: message çš„ç°¡å¯«
    });
  }
});

// ğŸšª åŠŸèƒ½8ï¼šä½¿ç”¨è€…ç™»å‡º
// å°±åƒæ˜¯åœ¨å­¸æ ¡é–€å£äº¤å›é€šè¡Œè­‰ï¼Œèªªã€Œæˆ‘è¦å›å®¶äº†ã€
router.post("/logout", checkToken, async (req, res) => {
  try {
    // å˜—å˜—çœ‹èƒ½ä¸èƒ½æˆåŠŸç™»å‡º
    // å¾ç™»å…¥è¨¼æ˜ä¸­å–å¾—ä½¿ç”¨è€…çš„å¸³è™Ÿ
    const { account } = req.decoded;

    // ç¢ºèªé€™å€‹å¸³è™ŸçœŸçš„å­˜åœ¨æ–¼è³‡æ–™åº«ä¸­
    const sqlCheck1 = "SELECT * FROM `users` WHERE `account` = ?;";
    let user = await connection
      .execute(sqlCheck1, [account])
      .then(([result]) => {
        return result[0];
      });

    // å¦‚æœæ‰¾ä¸åˆ°é€™å€‹ä½¿ç”¨è€…ï¼Œè¡¨ç¤ºæœ‰å•é¡Œ
    if (!user) {
      const err = new Error("ç™»å‡ºå¤±æ•—"); // å¯èƒ½æ˜¯å¸³è™Ÿå·²è¢«åˆªé™¤æˆ–è€…è¨¼æ˜æœ‰å•é¡Œ
      err.code = 401; // 401ä»£è¡¨ã€Œç„¡æ¬Šé™ã€
      err.status = "error";
      throw err;
    }

    // è£½ä½œä¸€å€‹å·²éæœŸçš„è¨¼æ˜ï¼Œè®“èˆŠçš„ç™»å…¥è¨¼æ˜å¤±æ•ˆ
    // å°±åƒæ˜¯æŠŠé€šè¡Œè­‰æ’°æˆã€Œå·²å¤±æ•ˆã€
    const token = jwt.sign(
      {
        message: "éæœŸçš„token", // æ¨™è¨˜ç‚ºå·²éæœŸçš„è¨¼æ˜
      },
      secretKey,
      { expiresIn: "-10s" } // è¨­å®š-10ç§’ï¼Œè¡¨ç¤º10ç§’å‰å°±éæœŸäº†
    );

    // ç™»å‡ºæˆåŠŸï¼
    res.status(200).json({
      status: "success", // å‘Šè¨´ä½¿ç”¨è€…ï¼šã€Œç™»å‡ºæˆåŠŸï¼ã€
      message: "ç™»å‡ºæˆåŠŸ", // é“åˆ¥è¨Šæ¯
      data: token, // çµ¦ä¸€å€‹å·²éæœŸçš„è¨¼æ˜ï¼Œè®“èˆŠè¨¼æ˜å¤±æ•ˆ
    });
  } catch (error) {
    // å¦‚æœç™»å‡ºéç¨‹ä¸­å‡ºéŒ¯çš„è©±
    // æ•ç²éŒ¯èª¤è™•ç†
    console.log(error);
    const statusCode = error.code ?? 400;
    const statusText = error.status ?? "error";
    const message = error.message ?? "ç™»å‡ºå¤±æ•—ï¼Œè«‹æ´½ç®¡ç†äººå“¡";
    res.status(statusCode).json({
      status: statusText,
      message, // message: message
    });
  }
});

// ğŸ“Š åŠŸèƒ½9ï¼šæª¢æŸ¥ç™»å…¥ç‹€æ…‹
// å°±åƒæ˜¯å•ã€Œæˆ‘é‚„æœ‰æ²’æœ‰æ¬Šé™é€²å…¥å­¸æ ¡ï¼Ÿã€
router.post("/status", checkToken, async (req, res) => {
  try {
    // å˜—å˜—çœ‹èƒ½ä¸èƒ½æˆåŠŸç¢ºèªç‹€æ…‹
    // å¾ç™»å…¥è¨¼æ˜ä¸­å–å¾—ä½¿ç”¨è€…çš„å¸³è™Ÿ
    const { account } = req.decoded;

    // ç¢ºèªé€™å€‹å¸³è™Ÿä»ç„¶å­˜åœ¨æ–¼è³‡æ–™åº«ä¸­ï¼ˆæ²’æœ‰è¢«åˆªé™¤ï¼‰
    const sqlCheck1 = "SELECT * FROM `users` WHERE `account` = ?;";
    let user = await connection
      .execute(sqlCheck1, [account])
      .then(([result]) => {
        return result[0];
      });

    // å¦‚æœæ‰¾ä¸åˆ°é€™å€‹ä½¿ç”¨è€…ï¼Œè¡¨ç¤ºå¸³è™Ÿå·²è¢«åˆªé™¤æˆ–æœ‰å•é¡Œ
    if (!user) {
      const err = new Error("è«‹ç™»å…¥"); // è¦æ±‚é‡æ–°ç™»å…¥
      err.code = 401; // 401ä»£è¡¨ã€Œç„¡æ¬Šé™ã€
      err.status = "error";
      throw err;
    }

    // ç‹€æ…‹æ­£å¸¸ï¼ç”¢ç”Ÿä¸€å€‹æ–°çš„ç™»å…¥è¨¼æ˜ï¼ˆå°±åƒçºŒç±¤é€šè¡Œè­‰ï¼‰
    const token = jwt.sign(
      {
        // ç”¨æœ€æ–°çš„ä½¿ç”¨è€…è³‡æ–™è£½ä½œè¨¼æ˜
        account: user.account,
        mail: user.mail,
        head: user.head,
      },
      secretKey,
      { expiresIn: "30m" } // æ–°è¨¼æ˜åˆå¯ä»¥ç”¨30åˆ†é˜
    );

    // å‘Šè¨´ä½¿ç”¨è€…ï¼šã€Œä½ é‚„åœ¨ç™»å…¥ç‹€æ…‹ï¼ã€
    res.status(200).json({
      status: "success", // ç‹€æ…‹æ­£å¸¸
      message: "è™•æ–¼ç™»å…¥ç‹€æ…‹", // ç¢ºèªè¨Šæ¯
      data: token, // çµ¦æ–°çš„ç™»å…¥è¨¼æ˜
    });
  } catch (error) {
    // æ•ç²éŒ¯èª¤
    console.log(error);
    const statusCode = error.code ?? 401;
    const statusText = error.status ?? "error";
    const message = error.message ?? "èº«åˆ†é©—è­‰éŒ¯èª¤ï¼Œè«‹æ´½ç®¡ç†äººå“¡";
    res.status(statusCode).json({
      status: statusText,
      message, // message: message
    });
  }
});

// ğŸ” è¼”åŠ©å‡½æ•¸ï¼šæª¢æŸ¥ç™»å…¥è¨¼æ˜
// é€™å€‹å‡½æ•¸å°±åƒå­¸æ ¡çš„é–€ç•¶ï¼Œæª¢æŸ¥æ¯å€‹äººçš„é€šè¡Œè­‰æ˜¯å¦æœ‰æ•ˆ
function checkToken(req, res, next) {
  // å¾è«‹æ±‚æ¨™é ­ä¸­å–å¾—ç™»å…¥è¨¼æ˜
  // å°±åƒæ˜¯çœ‹ä¾†è¨ªè€…æœ‰æ²’æœ‰å¸¶èº«åˆ†è­‰
  let token = req.get("Authorization");
  console.log(token); // åœ¨æ§åˆ¶å°é¡¯ç¤ºæ”¶åˆ°çš„è¨¼æ˜ï¼Œæ–¹ä¾¿é™¤éŒ¯

  // æª¢æŸ¥æ˜¯å¦æœ‰è¨¼æ˜ï¼Œä¸”æ˜¯å¦ä»¥"Bearer "é–‹é ­ï¼ˆæ¨™æº–æ ¼å¼ï¼‰
  if (token && token.includes("Bearer ")) {
    // ç§»é™¤"Bearer "çš„éƒ¨åˆ†ï¼Œåªä¿ç•™çœŸæ­£çš„è¨¼æ˜å…§å®¹
    // slice(7)æ„æ€æ˜¯å¾ç¬¬7å€‹å­—å…ƒé–‹å§‹æˆªå–ï¼ˆ"Bearer "æœ‰ç­‰7å€‹å­—å…ƒï¼‰
    token = token.slice(7);

    // é©—è­‰è¨¼æ˜æ˜¯å¦æœ‰æ•ˆï¼šå°±åƒæ˜¯æª¢æŸ¥èº«åˆ†è­‰çš„çœŸå‡
    jwt.verify(token, secretKey, (error, decoded) => {
      if (error) {
        // å¦‚æœè¨¼æ˜æœ‰å•é¡Œï¼ˆéæœŸã€è¢«ç²„æ”¹ã€æ ¼å¼éŒ¯èª¤ç­‰ï¼‰
        console.log(error); // å°å‡ºéŒ¯èª¤è¨Šæ¯
        res.status(401).json({
          // 401ä»£è¡¨ã€Œç„¡æ¬Šé™ã€
          status: "error",
          message: "ç™»å…¥é©—è­‰å¤±æ•ˆï¼Œè«‹é‡æ–°ç™»å…¥", // è¦æ±‚é‡æ–°ç™»å…¥
        });
        return; // çµæŸå‡½æ•¸ï¼Œä¸è®“ä½¿ç”¨è€…é€²å…¥
      }
      // è¨¼æ˜æœ‰æ•ˆï¼æŠŠè¨¼æ˜ä¸­çš„ä½¿ç”¨è€…è³‡è¨Šå­˜åˆ°reqä¸­ï¼Œä¾›å¾ŒçºŒä½¿ç”¨
      req.decoded = decoded;
      next(); // é€šè¡Œï¼è®“ä½¿ç”¨è€…ç¹¼çºŒä½¿ç”¨å…¶ä»–åŠŸèƒ½
    });
  } else {
    // å¦‚æœæ²’æœ‰è¨¼æ˜æˆ–æ ¼å¼ä¸å°
    res.status(401).json({
      status: "error",
      message: "ç„¡ç™»å…¥é©—è­‰è³‡æ–™ï¼Œè«‹é‡æ–°ç™»å…¥", // è¦æ±‚å…ˆå»ç™»å…¥
    });
  }
}

// ğŸ–¼ï¸ è¼”åŠ©å‡½æ•¸ï¼šå–å¾—éš¨æ©Ÿé ­åƒ
// é€™å€‹å‡½æ•¸å°±åƒæ˜¯å»ç…§ç›¸é¤¨å¹«æ–°å­¸ç”Ÿæ‹å­¸ç”Ÿè­‰ç…§ç‰‡
async function getRandomAvatar() {
  // è¨­å®šè¦å»çš„APIç¶²å€ï¼Œé€™æ˜¯ä¸€å€‹å…è²»æä¾›éš¨æ©Ÿä½¿ç”¨è€…è³‡æ–™çš„ç¶²ç«™
  const API = "https://randomuser.me/api";

  try {
    // å˜—å˜—çœ‹èƒ½ä¸èƒ½æˆåŠŸå–å¾—ç…§ç‰‡
    // å‘ç¶²ç«™ç™¼å‡ºè«‹æ±‚ï¼Œå°±åƒæ˜¯æ‰“é›»è©±å•ï¼šã€Œèƒ½çµ¦æˆ‘ä¸€å¼µéš¨æ©Ÿç…§ç‰‡å—ï¼Ÿã€
    const response = await fetch(API);

    // æª¢æŸ¥æ˜¯å¦æˆåŠŸå–å¾—å›æ‡‰
    if (!response.ok)
      throw new Error(`${response.status}: ${response.statusText}`);

    // æŠŠå›æ‡‰è½‰æ›æˆJSONæ ¼å¼ï¼Œå°±åƒæ˜¯æŠŠç¶²ç«™çš„å›æ‡‰è½‰æˆæˆ‘å€‘çœ‹å¾—æ‡‚çš„æ ¼å¼
    const result = await response.json();

    // å¾ç¶²ç«™çš„å›æ‡‰ä¸­å–å¾—å¤§å°ºå¯¸çš„é ­åƒç…§ç‰‡ç¶²å€
    // https://randomuser.me/api çš„ API JSONæª”ä¸­ï¼Œresults[0].picture.large å°±æ˜¯å¤§é ­åƒçš„ç¶²å€
    return result.results[0].picture.large;
  } catch (error) {
    // å¦‚æœå–å¾—é ­åƒå¤±æ•—çš„è©±
    // åœ¨æ§åˆ¶å°å°å‡ºéŒ¯èª¤è¨Šæ¯ï¼Œä½†ä¸è®“ç¨‹å¼å´©æ½°
    console.log("getRandomAvatar", error.message);
    return null; // å›å‚³nullï¼Œè¡¨ç¤ºæ²’æœ‰å–å¾—é ­åƒ
  }
}

// æŠŠé€™å€‹ä½¿ç”¨è€…æœå‹™ä¸­å¿ƒçš„è·¯ç”±å™¨åŒ¯å‡ºï¼Œè®“ä¸»ç¨‹å¼å¯ä»¥ä½¿ç”¨
// å°±åƒæ˜¯æŠŠæ•´å€‹ä½¿ç”¨è€…æœå‹™éƒ¨é–€æ¬åˆ°å¤§å»³çµ¦å¤§å®¶ä½¿ç”¨
export default router;
